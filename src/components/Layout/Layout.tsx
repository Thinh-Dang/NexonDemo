import { FC, useEffect, useState } from 'react';
import style from './Layout.module.scss';

import Head from 'next/head';
import { useRouter } from 'next/router';
import { isMobile } from 'react-device-detect';
import { getProfile } from '@/redux/slice/userSlice';
import { useAppSelector, RootState, useAppDispatch } from '@/redux';

import { Footer, Header } from '../common';
import { Loading } from '../Loading/Loading';

import { Alert } from 'antd';
import { ILayout } from '@/@type/components';

export const Layout: FC<ILayout> = ({
  children,
  isHeader = true,
  isFooter = true,
  isLogo = false,
  title,
}) => {
  const router = useRouter();
  const location = router.pathname;
  const dispatch = useAppDispatch();
  const [isFetch, setIsFetch] = useState(false);
  const isLogin = useAppSelector((state: RootState) => state.userSlice.isLogin);

  const fetchInfo = async () => {
    const check = (await dispatch(getProfile())).payload;

    if (check) {
      setIsFetch(true);
    }
  };

  useEffect(() => {
    fetchInfo();
  }, []);

  if (isMobile) {
    if (!isFetch) {
      return <Loading />;
    }

    if (!isLogin && location !== '/auth/login' && location !== '/') {
      router.push('/');
    }

    if (isLogin && location === '/auth/login') {
      router.push('/finding');
      return <Loading />;
    }

    return (
      <div className={style.layout}>
        <Head>
          <title>{title}</title>
          <meta name="description" content="Generated by create next app" />
          <link rel="icon" href="/favicon.ico" />
        </Head>
        {isHeader && <Header isLogo={isLogo} />}
        <div className={style.children}>{children}</div>
        {isFooter && <Footer />}
      </div>
    );
  }

  return (
    <div className={style.layout__alert}>
      <Alert
        message="CẢNH BÁO THIẾT BỊ"
        description="Website chỉ hoạt động trên thiết bị mobile. Cảm ơn !!!"
        type="error"
        showIcon
      />
    </div>
  );
};
